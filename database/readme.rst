Rfam-RNAcentral Database
========================
Tables
------
Table ``id_mapping``
^^^^^^^^^^^^^^^^^^^^
Table generated from the file ``id_mapping`` file in the `RNAcentral FTP site <http://rnacentral.org/downloads>`_

.. code :: SQL

	CREATE TABLE id_mapping (
		id INT(10),
		db VARCHAR(100),
		db_acc VARCHAR(100),
		tax_id VARCHAR(30),
		rna_type VARCHAR(10)
		);

	ALTER TABLE id_mapping
	ADD PRIMARY KEY (id)
	
	LOAD DATA LOCAL INFILE "path/to/id_mapping.txt" INTO TABLE id_mapping;

Table ``taxonomy``
^^^^^^^^^^^^^^^^^^
Table generated from a selection of the ``taxonomy`` table in `Rfam public database <http://rfam.github.io/docs/>`_.

Saved query as ``taxonomy.txt``:

.. code :: SQL

	SELECT t.ncbi_id, t.species, t.tax_string
	FROM taxonomy t
		
Table generated:

.. code :: SQL

	CREATE TABLE taxonomy (
		ncbi_id INT(10),
		species VARCHAR(100),
		tax_string VARCHAR(100)
		);

	ALTER TABLE taxonomy
	ADD PRIMARY KEY (ncbi_id)


	LOAD DATA LOCAL INFILE "path/to/taxonomy.txt" INTO TABLE taxonomy IGNORE 1 LINES;

Table ``length``
^^^^^^^^^^^^^^^^
Table generated from output of ``fasta_seq-len.py`` script `(here) <https://github.com/nataquinones/Rfam-RNAcentral/blob/master/fasta_slicer/fasta_seq-len.py>`_. when running it for file ``rnacentral_active.fasta`` from the RNAcentral FTP page

.. code :: SQL

	CREATE TABLE length
	(id VARCHAR(13),
	hit_rfam_acc INT(6)
	);
	
	LOAD DATA LOCAL INFILE "path/to/file_seq-len.txt" INTO TABLE length IGNORE 1 LINES;

Table ``cmscan_run``
^^^^^^^^^^^^^^^^^^^
Table to keep track of URSs that have already been scanned. It is generated from output of ``fasta_id.py`` script `(here) <https://github.com/nataquinones/Rfam-RNAcentral/blob/master/fasta_slicer/fasta_id.py>`_. when running it for a certain scanned file (slices generated by ``fasta_slicer.py`` (`here <https://github.com/nataquinones/Rfam-RNAcentral/tree/master/fasta_slicer>`_) )

.. code :: SQL

	CREATE TABLE length
	(id VARCHAR(13),
	hit_rfam_acc INT(6)
	);
	
	LOAD DATA LOCAL INFILE "path/to/file_seq-ids.txt" INTO TABLE length IGNORE 1 LINES;

Table ``cmscan_hits``
^^^^^^^^^^^^^^^^^^^^^^^
Table to input files from cmscan process (`here <https://github.com/nataquinones/Rfam-RNAcentral/tree/master/cmscan_rfam>`_) and after being parsed by  `parser_cmscan <https://github.com/nataquinones/Rfam-RNAcentral/tree/master/parser_cmscan>`_ 

.. code :: SQL

	CREATE TABLE cmscan_hits
	(id VARCHAR(13),
	hit_rfam_acc VARCHAR(7),
	fam_name VARCHAR(30),
	hit_clan_acc VARCHAR(7),
	olp VARCHAR(1),
	e_value VARCHAR(10)
	);

Make forgein key:

.. code :: SQL

	ALTER TABLE cmscan_hits
	ADD FOREIGN KEY (id)
	REFERENCES rnacentral_map (id);

Load files into table:

.. code :: SQL

	LOAD DATA LOCAL INFILE "parsed_file.txt" INTO TABLE cmscan_hits IGNORE 1 LINES;

Table ``rnacentral_map``
^^^^^^^^^^^^^^^^^^^^^^^
Uses ``id_mapping`` table and collapses certain fields to make queries easier

.. code :: SQL

	CREATE TABLE rnacentral_map
	SELECT 
		im.id, 
		GROUP_CONCAT(DISTINCT im.db) AS db,
		GROUP_CONCAT(DISTINCT IF(im.db LIKE '%RFAM%',im.db_acc,NULL)) AS rfam_acc,
		GROUP_CONCAT(DISTINCT im.rna_type) AS rna_type
		#GROUP_CONCAT(DISTINCT im.tax_id) AS tax_id
	FROM id_mapping im
	GROUP BY im.id

Make ``id`` primary key:

.. code :: SQL

	ALTER TABLE rnacentral_map
	ADD PRIMARY KEY (id);

Group queries
--------------

+----------------------------------------------------------+----------------------------------+
| Rfam                                                     | No Rfam                          |
+---------------------------------------+------------------+-----------------+----------------+
| Hits                                  | No hits          | Hits            | No hits        |
+-----------------+---------------------+                  |                 |                |
| Same            | Not-same            |                  |                 |                |
+-----------------+---------------------+------------------+-----------------+----------------+
| **SAME HIT**    | **CONFLICTING HIT** | **LOST IN SCAN** | **NEW MEMBERS** | **NEW FAMILY** |
+-----------------+---------------------+------------------+-----------------+----------------+

1. SAME HIT
^^^^^^^^^^^

*RNAcentral sequence is in Rfam, has a hit that is the same as the Rfam annotation.*

.. code :: SQL

	SELECT
		rm.id, rm.db, rm.rna_type, rm.rfam_acc, ch.hit_rfam_acc, ch.hit_clan_acc
	FROM rnacentral_map rm
	LEFT JOIN cmscan_hits ch ON rm.id=ch.id
	WHERE rm.rfam_acc IS NOT NULL -- in Rfam
	AND ch.hit_rfam_acc IS NOT NULL -- got hit
	AND rm.rfam_acc = ch.hit_rfam_acc -- same

2. CONFLICTING HIT
^^^^^^^^^^^^^^^^^^

*RNAcentral sequence is in Rfam, has a hit that is not the same as the Rfam annotation.*

.. code :: SQL

	SELECT
		rm.id, rm.db, rm.rna_type, rm.rfam_acc, ch.hit_rfam_acc, ch.hit_clan_acc
	FROM rnacentral_map rm
	LEFT JOIN cmscan_hits ch ON rm.id=ch.id
	WHERE rm.rfam_acc IS NOT NULL -- in Rfam
	AND ch.hit_rfam_acc IS NOT NULL -- got hit
	AND rm.rfam_acc != ch.hit_rfam_acc -- different

3. LOST IN SCAN
^^^^^^^^^^^^^^^

*RNAcentral sequence is in Rfam, but had no hits in cmscan.*

.. code :: SQL

	SELECT
		rm.id, rm.db, rm.rna_type, rm.rfam_acc, ch.hit_rfam_acc
	FROM rnacentral_map rm
	LEFT JOIN cmscan_hits ch ON rm.id = ch.id
	WHERE rm.rfam_acc IS NOT NULL -- in Rfam
	AND ch.hit_rfam_acc IS NULL -- no hit

4. NEW MEMBERS
^^^^^^^^^^^^^^^

*RNAcentral sequence is not Rfam, but had hits.*


.. code:: SQL

	SELECT
		rm.id, rm.db, rm.rna_type, rm.rfam_acc, ch.hit_rfam_acc, ch.hit_clan_acc
	FROM rnacentral_map rm
	LEFT JOIN cmscan_hits ch ON rm.id = ch.id
	WHERE rm.rfam_acc IS NULL -- not in Rfam
	AND ch.hit_rfam_acc IS NOT NULL -- got hit

5. NEW FAMILY
^^^^^^^^^^^^^^^

*RNAcentral sequence is not Rfam, and had hits.*

.. code:: SQL

	SELECT
		rm.id, rm.db, rm.rna_type, rm.rfam_acc, ch.hit_rfam_acc, ch.hit_clan_acc
	FROM rnacentral_map rm
	LEFT JOIN cmscan_hits ch ON rm.id=ch.id
	WHERE rm.rfam_acc IS NULL -- not in Rfam
	AND ch.hit_rfam_acc IS NULL -- no hit

Overcounting issue
------------------
TOTAL:

+--------------------------+-----------+
| id_mapping               | 9 386 122 |
+--------------------------+-----------+
| rnacentral_nhmmer.fasta  | 9 386 112 |
+--------------------------+-----------+

All groups should be mutually exclusive, but with the previous queries there'll be redundancy in `SAME HIT` and `CONFLICTING HIT` caused by multiple hits in a same RNAcentral sequence:

+----+----------+----------+-----------------+
| id | rfam_acc | hit_rfam | GROUP           |
+====+==========+==========+=================+
| 1  | A        | A        | SAME HIT        |
+----+----------+----------+-----------------+
| 2  | A        | B        | CONFLICTING HIT |
+----+----------+----------+-----------------+
| 3  | A        | A        | SAME HIT        |
+----+----------+----------+-----------------+
| 3  | A        | B        | CONFLICTING HIT |
+----+----------+----------+-----------------+
| 4  | A        | A        | SAME HIT        |
+----+----------+----------+-----------------+
| 4  | A        | B        | CONFLICTING HIT |
+----+----------+----------+-----------------+
| 4  | A        | C        | CONFLICTING HIT |
+----+----------+----------+-----------------+

.. code::

	G1 + G2 = TOTAL - (G3 + G4 + G5)

To discern bewteen G1 and G2, multiple hits can be collapsed:

.. code:: SQL

	SELECT
		ch.id, GROUP_CONCAT(DISTINCT ch.hit_rfam_acc) AS families
	FROM cmscan_hits ch 
	GROUP BY ch.id
